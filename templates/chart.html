<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iRidi Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--tg-theme-bg-color, #1a1a2e); color: var(--tg-theme-text-color, #ffffff); }
        .header { text-align: center; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .tag-selector { width: 100%; max-width: 300px; margin: 10px auto; display: block; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #2a2a4e; color: #fff; }
        button { padding: 10px 20px; border: none; border-radius: 8px; background: var(--tg-theme-button-color, #4ECDC4); color: var(--tg-theme-button-text-color, #ffffff); cursor: pointer; font-size: 14px; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #chart { width: 100%; height: 400px; border-radius: 12px; overflow: hidden; }
        .info { text-align: center; margin-top: 15px; font-size: 12px; opacity: 0.7; }
        .loading { text-align: center; padding: 40px; color: var(--tg-theme-hint-color, #888); }
        .error { text-align: center; padding: 20px; color: #ff6b6b; background: rgba(255,107,107,0.1); border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h2>üìä iRidi Dashboard</h2>
        <p id="subtitle">–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ SCADA ‚Ä¢ v9.0</p>
    </div>
    
    <select id="tagSelect" class="tag-selector" onchange="changeTag()">
        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤...</option>
    </select>
    
    <div class="controls">
        <button onclick="updateChart('1h')" id="btn-1h">1 —á–∞—Å</button>
        <button onclick="updateChart('24h')" id="btn-24h">24 —á–∞—Å–∞</button>
        <button onclick="updateChart('7d')" id="btn-7d">7 –¥–Ω–µ–π</button>
        <button onclick="downloadChart()">üì• –°–∫–∞—á–∞—Ç—å PNG</button>
    </div>
    
    <div id="chart">
        <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
    </div>
    
    <div class="info">
        <p id="dataInfo">üóÑÔ∏è –î–∞–Ω–Ω—ã–µ –∏–∑ PostgreSQL</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        let currentPeriod = '24h';
        let currentTagId = new URLSearchParams(window.location.search).get('metric') || '1';
        let chartData = { labels: [], values: [], unit: '' };
        let tagName = '';
        
        async function loadTags() {
            try {
                const response = await fetch('/api/tags');
                const data = await response.json();
                const select = document.getElementById('tagSelect');
                select.innerHTML = '';
                
                data.tags.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name;
                    if (tag.id == currentTagId) {
                        option.selected = true;
                        tagName = tag.name;
                    }
                    select.appendChild(option);
                });
                
                updateSubtitle();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–≥–æ–≤:', error);
            }
        }
        
        function updateSubtitle() {
            document.getElementById('subtitle').textContent = `${tagName || '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥'} ‚Ä¢ v9.0`;
        }
        
        function changeTag() {
            const select = document.getElementById('tagSelect');
            currentTagId = select.value;
            tagName = select.options[select.selectedIndex].text;
            updateSubtitle();
            updateChart(currentPeriod);
        }
        
        async function fetchData(period, tagId) {
            const response = await fetch(`/api/data?metric=${tagId}&period=${period}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }
        
        function formatLabel(timestamp, period) {
            // ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–µ—Ä–∏–æ–¥–∞
            const date = new Date(timestamp);
            if (period === '1h' || period === '24h') {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } else if (period === '7d') {
                return date.toLocaleString('ru-RU', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }).replace(',', '');
            }
            return date.toLocaleString('ru-RU');
        }
        
        function renderChart() {
            const chartDiv = document.getElementById('chart');
            
            if (!chartData.labels.length) {
                chartDiv.innerHTML = '<div class="error">‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
                return;
            }
            
            const unit = chartData.unit || '';
            const trace = {
                type: 'scatter',
                mode: 'lines+markers',
                x: chartData.labels,
                y: chartData.values,
                name: tagName,
                line: { color: '#4ECDC4', width: 2 },
                marker: { size: 4 },
                hovertemplate: '%{x}<br>–ó–Ω–∞—á–µ–Ω–∏–µ: %{y}' + unit + '<extra></extra>'
            };
            
            const layout = {
                title: `${tagName} ‚Ä¢ ${currentPeriod}`,
                template: 'plotly_dark',
                xaxis: { 
                    title: '–í—Ä–µ–º—è', 
                    tickangle: -45,
                    tickfont: { size: 10 }
                },
                yaxis: { title: unit ? `–ó–Ω–∞—á–µ–Ω–∏–µ (${unit})` : '–ó–Ω–∞—á–µ–Ω–∏–µ' },
                margin: { t: 50, b: 80, l: 50, r: 20 },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('chart', [trace], layout, {responsive: true, displayModeBar: true});
        }
        
        async function updateChart(period) {
            currentPeriod = period;
            document.querySelectorAll('.controls button').forEach(btn => btn.style.opacity = '1');
            document.getElementById(`btn-${period}`).style.opacity = '0.7';
            
            const chartDiv = document.getElementById('chart');
            chartDiv.innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –†–ï–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ SCADA...</div>';
            
            try {
                const data = await fetchData(period, currentTagId);
                
                if (data.message) {
                    chartDiv.innerHTML = `<div class="error">‚ö†Ô∏è ${data.message}</div>`;
                    return;
                }
                
                // ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
                chartData.labels = data.labels;  // –£–∂–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                chartData.values = data.values;
                chartData.unit = data.unit;
                
                document.getElementById('dataInfo').textContent = `üóÑÔ∏è –ó–∞–ø–∏—Å–µ–π: ${data.count || 0} ‚Ä¢ –ï–¥–∏–Ω–∏—Ü–∞: ${data.unit || '–Ω/–¥'}`;
                renderChart();
            } catch (error) {
                chartDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }
        
        function downloadChart() {
            if (!chartData.labels.length) return;
            Plotly.downloadImage('chart', {format: 'png', width: 1200, height: 600, filename: `iridi_${currentTagId}_${currentPeriod}`});
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadTags();
        updateChart(currentPeriod);
    </script>
</body>
</html>