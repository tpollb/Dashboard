<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iRidi Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #1a1a2e);
            color: var(--tg-theme-text-color, #ffffff);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--tg-theme-button-color, #4ECDC4);
            color: var(--tg-theme-button-text-color, #ffffff);
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { opacity: 0.9; }
        #chart { 
            width: 100%; 
            height: 400px; 
            border-radius: 12px;
            overflow: hidden;
        }
        .info {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>üìä iRidi Dashboard</h2>
        <p id="subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫</p>
    </div>
    
    <div class="controls">
        <button onclick="updateChart('1h')">1 —á–∞—Å</button>
        <button onclick="updateChart('24h')">24 —á–∞—Å–∞</button>
        <button onclick="updateChart('7d')">7 –¥–Ω–µ–π</button>
        <button onclick="toggleType()">üìà –¢–∏–ø: <span id="typeLabel">–õ–∏–Ω–µ–π–Ω—ã–π</span></button>
        <button onclick="downloadChart()">üì• –°–∫–∞—á–∞—Ç—å PNG</button>
    </div>
    
    <div id="chart"></div>
    
    <div class="info">
        <p>ü§ñ –î–∞–Ω–Ω—ã–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ ‚Ä¢ v6.0 Web App</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        let currentPeriod = '24h';
        let currentType = 'line';
        let chartData = {};
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const metric = urlParams.get('metric') || 'temperature';
        const period = urlParams.get('period') || '24h';
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–º–æ–∫–æ–≤—ã–µ –¥–ª—è –¥–µ–º–æ)
        function generateData(period, metric) {
            const now = new Date();
            const points = period === '1h' ? 12 : period === '24h' ? 24 : 7;
            const step = period === '1h' ? 5 : period === '24h' ? 60 : 1440; // –º–∏–Ω—É—Ç—ã
            
            const labels = [];
            const values = [];
            const base = {temperature: 22, pressure: 1013, cpu_load: 45, light: 300}[metric] || 50;
            
            for (let i = 0; i < points; i++) {
                const time = new Date(now.getTime() - (points - i) * step * 60000);
                labels.push(time.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    day: period === '7d' ? 'numeric' : undefined,
                    month: period === '7d' ? 'numeric' : undefined
                }));
                values.push(base + Math.random() * 20 - 10 + (i * 0.3));
            }
            
            return { labels, values };
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        function renderChart() {
            chartData = generateData(currentPeriod, metric);
            
            const trace = currentType === 'line' ? {
                type: 'scatter',
                mode: 'lines+markers',
                x: chartData.labels,
                y: chartData.values,
                name: metric,
                line: { color: '#4ECDC4', width: 2 },
                marker: { size: 4 }
            } : {
                type: 'bar',
                x: chartData.labels,
                y: chartData.values,
                name: metric,
                marker: { color: '#4ECDC4' }
            };
            
            const layout = {
                title: `${metric.toUpperCase()} ‚Ä¢ ${currentPeriod}`,
                template: 'plotly_dark',
                xaxis: { title: '–í—Ä–µ–º—è' },
                yaxis: { title: metric === 'temperature' ? '¬∞C' : metric === 'pressure' ? '–≥–ü–∞' : metric === 'cpu_load' ? '%' : '–ª–∫' },
                margin: { t: 50, b: 50, l: 50, r: 20 },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('chart', [trace], layout, {responsive: true, displayModeBar: true});
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞
        function updateChart(period) {
            currentPeriod = period;
            renderChart();
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞
        function toggleType() {
            currentType = currentType === 'line' ? 'bar' : 'line';
            document.getElementById('typeLabel').textContent = currentType === 'line' ? '–õ–∏–Ω–µ–π–Ω—ã–π' : '–°—Ç–æ–ª–±—Ü—ã';
            renderChart();
        }
        
        // –°–∫–∞—á–∞—Ç—å PNG
        function downloadChart() {
            Plotly.downloadImage('chart', {format: 'png', width: 800, height: 600, filename: `iridi_${metric}_${currentPeriod}`});
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        currentPeriod = period;
        renderChart();
    </script>
</body>
</html>